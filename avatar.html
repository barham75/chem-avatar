<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Conference Avatar Assistant</title>

<style>
    body {
        background: #000814;
        color: #fff;
        font-family: Tahoma, Arial;
        text-align: center;
        margin: 0;
    }

    h1 {
        margin-top: 20px;
        font-size: 26px;
    }

    #avatar-container {
        width: 100%;
        height: 420px;
        background: #001d3d;
    }

    #chat-area {
        width: 80%;
        margin: 20px auto;
        padding: 15px;
        background: #001021;
        border-radius: 12px;
        height: 260px;
        overflow-y: auto;
        text-align: left;
    }

    .bubble {
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 12px;
        max-width: 80%;
    }

    .q {
        background: #003566;
        color: #fca311;
        align-self: flex-start;
    }

    .a {
        background: #001d3d;
        color: #80ed99;
        align-self: flex-end;
    }

    #controls {
        margin-top: 15px;
    }

    input {
        width: 50%;
        padding: 10px;
        border-radius: 10px;
        border: none;
    }

    button {
        padding: 10px 15px;
        margin-right: 10px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
    }

    .send-btn { background: #00b4d8; color: white; }
    .voice-btn { background: #fca311; }
    .back-btn  { background: #94d2bd; margin-top: 15px; }
</style>

<script src="https://unpkg.com/@readyplayerme/visage@latest"></script>

</head>
<body>

<h1>ðŸ¤– Intelligent Avatar â€“ Chemistry Conference</h1>

<div id="avatar-container"></div>

<div id="chat-area"></div>

<div id="controls">
    <input id="question" placeholder="Type your question...">
    <button class="send-btn" onclick="askBot()">Send</button>
    <button class="voice-btn" onclick="speakNow()">ðŸŽ¤ Voice Question</button>
</div>

<button class="back-btn" onclick="window.location.href='index.html'">Back</button>

<script>
const avatarUrl = "https://models.readyplayer.me/65a7a4a3758e2d309f32e3d4.glb";

const viewer = new window.RPMVisage.AvatarScene({
    container: document.getElementById("avatar-container"),
    avatarUrl: avatarUrl,
    idleAnimation: true,
    autoRotate: true,
    lipsync: true,
});

function addBubble(text, type) {
    let div = document.createElement("div");
    div.className = "bubble " + (type === "q" ? "q" : "a");
    div.innerHTML = text;
    document.getElementById("chat-area").appendChild(div);
    document.getElementById("chat-area").scrollTop = 999999;
}

async function askBot() {
    let q = document.getElementById("question").value.trim();
    if (!q) return;

    addBubble("Question: " + q, "q");

    viewer.playTalkingAnimation();

    const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: q })
    });

    const data = await res.json();

    addBubble("EN Answer: " + data.answer_en, "a");

    if (data.voice) {
        let audio = new Audio("data:audio/wav;base64," + data.voice);
        audio.play();
        audio.onended = () => viewer.stopTalkingAnimation();
    }

    document.getElementById("question").value = "";
}

function speakNow() {
    if (!("webkitSpeechRecognition" in window)) {
        alert("Voice input not supported");
        return;
    }

    let rec = new webkitSpeechRecognition();
    rec.lang = "ar-SA";

    rec.onresult = ev => {
        document.getElementById("question").value = ev.results[0][0].transcript;
        askBot();
    };

    rec.start();
}
</script>

</body>
</html>
