<script>
  // رابط موديل الروبوت الجاهز
  const avatarUrl = "https://models.readyplayer.me/65a7a4a3758e2d309f32e3d4.glb"; 

  // عرض الأفاتار داخل الصندوق
  const container = document.getElementById("avatar-container");

  const viewer = new window.RPMVisage.AvatarScene({
    container: container,
    avatarUrl: avatarUrl,
    idleAnimation: true,
    autoRotate: true,
    lipsync: true,
  });

  // وظيفة الكلام
  function speak(text) {
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "ar-SA";
    utter.rate = 1.05;
    utter.pitch = 1.0;
    synth.speak(utter);
  }

  // إرسال السؤال إلى السيرفر واستلام الإجابة
  async function askBot() {
    const input = document.getElementById("question");
    const q = input.value.trim();
    if (!q) return;

    // تشغيل حركة الفم
    viewer.playTalkingAnimation();

    let answer = "لم أتمكن من الحصول على الإجابة.";

    try {
      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: q })
      });

      const data = await res.json();
      answer = data.answer_ar || "لم أجد إجابة في ملف المؤتمر.";

    } catch (err) {
      answer = "حدث خطأ في الاتصال بالخادم.";
    }

    // نطق الإجابة
    speak(answer);

    // إيقاف حركة الفم بعد انتهاء الكلام
    setTimeout(() => viewer.stopTalkingAnimation(), answer.length * 85);

    input.value = "";
  }
</script>
